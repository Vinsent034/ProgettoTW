<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Accedi - StreetCats</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="logo">
                    üê± StreetCats
                </a>
                
                <div class="nav-buttons">
                    <a href="register.html" class="btn btn-primary">Registrati</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="form-container">
                <h2 class="form-title">Accedi al tuo Account</h2>
                
                <!-- Alert container per messaggi -->
                <div id="formAlerts"></div>
                
                <form id="loginForm">
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" 
                               class="form-control" 
                               id="email" 
                               name="email"
                               required
                               autocomplete="email"
                               placeholder="inserisci@tuaemail.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password *</label>
                        <input type="password" 
                               class="form-control" 
                               id="password" 
                               name="password"
                               required
                               autocomplete="current-password"
                               placeholder="La tua password">
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full" id="loginBtn">
                        Accedi
                    </button>
                </form>
                
                <div class="form-link">
                    <p>Non hai un account? 
                       <a href="register.html">Registrati qui</a>
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        // Script principale per login.html
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        function initializePage() {
            // Controlla se gi√† loggato
            if (Utils.AuthManager.isLoggedIn()) {
                window.alertManager.success('Sei gi√† loggato!');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                return;
            }

            // Setup form
            setupLoginForm();
            
            // Focus sul primo campo
            document.getElementById('email').focus();
        }

        function setupLoginForm() {
            const form = document.getElementById('loginForm');
            const submitBtn = document.getElementById('loginBtn');
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Disabilita pulsante per evitare doppio submit
                submitBtn.disabled = true;
                submitBtn.textContent = 'Accesso in corso...';
                
                try {
                    // Ottieni valori form
                    const formData = new FormData(form);
                    const email = formData.get('email').trim();
                    const password = formData.get('password');
                    
                    // Validazione basic
                    const errors = validateLoginForm(email, password);
                    if (errors.length > 0) {
                        showFormErrors(errors);
                        return;
                    }
                    
                    // Clear previous errors
                    clearFormErrors();
                    
                    // Chiama API login
                    const response = await Utils.ApiClient.post(
                        window.APP_CONFIG.API.ENDPOINTS.LOGIN,
                        { email, password }
                    );
                    
                    // Salva autenticazione
                    Utils.AuthManager.setAuth(response.token, response.user);
                    
                    // Success feedback
                    window.alertManager.success(window.APP_CONFIG.MESSAGES.SUCCESS.LOGIN);
                    
                    // Redirect
                    setTimeout(() => {
                        const redirectTo = Utils.UrlUtils.getQueryParam('redirect') || 'index.html';
                        window.location.href = redirectTo;
                    }, 1000);
                    
                } catch (error) {
                    console.error('Errore login:', error);
                    
                    // Mostra errore specifico
                    if (error.message.includes('401') || error.message.includes('non valide')) {
                        showFormErrors([window.APP_CONFIG.MESSAGES.ERROR.LOGIN_FAILED]);
                    } else {
                        showFormErrors([error.message || window.APP_CONFIG.MESSAGES.ERROR.GENERIC]);
                    }
                    
                } finally {
                    // Riabilita pulsante
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Accedi';
                }
            });
        }

        function validateLoginForm(email, password) {
            const errors = [];
            
            if (!email) {
                errors.push('Email √® obbligatoria');
            } else if (!Utils.ValidationUtils.validateEmail(email)) {
                errors.push('Email non √® valida');
            }
            
            if (!password) {
                errors.push('Password √® obbligatoria');
            }
            
            return errors;
        }

        function showFormErrors(errors) {
            const alertContainer = document.getElementById('formAlerts');
            alertContainer.innerHTML = errors.map(error => `
                <div class="alert alert-error">
                    ${error}
                </div>
            `).join('');
        }

        function clearFormErrors() {
            document.getElementById('formAlerts').innerHTML = '';
        }

        // Gestione tasto Enter
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const form = document.getElementById('loginForm');
                form.dispatchEvent(new Event('submit'));
            }
        });
    </script>
</body>
</html>