<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registrati - StreetCats</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="index.html" class="logo">
                    üê± StreetCats
                </a>
                
                <div class="nav-buttons">
                    <a href="login.html" class="btn btn-secondary">Accedi</a>
                </div>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <div class="form-container">
                <h2 class="form-title">Crea il tuo Account</h2>
                
                <p style="text-align: center; color: #7f8c8d; margin-bottom: 30px;">
                    Unisciti alla community di amanti dei gatti!
                </p>
                
                <!-- Alert container per messaggi -->
                <div id="formAlerts"></div>
                
                <form id="registerForm">
                    <div class="form-group">
                        <label for="name">Nome Completo *</label>
                        <input type="text" 
                               class="form-control" 
                               id="name" 
                               name="name"
                               required
                               autocomplete="name"
                               placeholder="Il tuo nome e cognome"
                               maxlength="50">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">Email *</label>
                        <input type="email" 
                               class="form-control" 
                               id="email" 
                               name="email"
                               required
                               autocomplete="email"
                               placeholder="inserisci@tuaemail.com">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Password *</label>
                        <input type="password" 
                               class="form-control" 
                               id="password" 
                               name="password"
                               required
                               autocomplete="new-password"
                               placeholder="Minimo 6 caratteri"
                               minlength="6">
                        <small style="color: #7f8c8d; font-size: 0.8rem;">
                            La password deve essere di almeno 6 caratteri
                        </small>
                    </div>
                    
                    <div class="form-group">
                        <label for="confirmPassword">Conferma Password *</label>
                        <input type="password" 
                               class="form-control" 
                               id="confirmPassword" 
                               name="confirmPassword"
                               required
                               autocomplete="new-password"
                               placeholder="Ripeti la password">
                    </div>
                    
                    <div class="form-group">
                        <label style="display: flex; align-items: center; gap: 10px; cursor: pointer;">
                            <input type="checkbox" id="terms" name="terms" required>
                            <span style="font-size: 0.9rem;">
                                Accetto di utilizzare l'app in modo responsabile e rispettoso verso gli animali
                            </span>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-full" id="registerBtn">
                        Crea Account
                    </button>
                </form>
                
                <div class="form-link">
                    <p>Hai gi√† un account? 
                       <a href="login.html">Accedi qui</a>
                    </p>
                </div>
            </div>
        </div>
    </main>

    <!-- Scripts -->
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/auth.js"></script>
    
    <script>
        // Script principale per register.html
        document.addEventListener('DOMContentLoaded', function() {
            initializePage();
        });

        function initializePage() {
            // Controlla se gi√† loggato
            if (Utils.AuthManager.isLoggedIn()) {
                window.alertManager.success('Sei gi√† loggato!');
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1500);
                return;
            }

            // Setup form
            setupRegisterForm();
            
            // Focus sul primo campo
            document.getElementById('name').focus();
        }

        function setupRegisterForm() {
            const form = document.getElementById('registerForm');
            const submitBtn = document.getElementById('registerBtn');
            
            // Validazione in tempo reale per conferma password
            const passwordField = document.getElementById('password');
            const confirmPasswordField = document.getElementById('confirmPassword');
            
            confirmPasswordField.addEventListener('input', function() {
                if (this.value && this.value !== passwordField.value) {
                    this.setCustomValidity('Le password non coincidono');
                } else {
                    this.setCustomValidity('');
                }
            });
            
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Disabilita pulsante per evitare doppio submit
                submitBtn.disabled = true;
                submitBtn.textContent = 'Creazione account...';
                
                try {
                    // Ottieni valori form
                    const formData = new FormData(form);
                    const name = formData.get('name').trim();
                    const email = formData.get('email').trim();
                    const password = formData.get('password');
                    const confirmPassword = formData.get('confirmPassword');
                    const termsAccepted = formData.get('terms');
                    
                    // Validazione
                    const errors = validateRegisterForm(name, email, password, confirmPassword, termsAccepted);
                    if (errors.length > 0) {
                        showFormErrors(errors);
                        return;
                    }
                    
                    // Clear previous errors
                    clearFormErrors();
                    
                    // Chiama API registrazione
                    const response = await Utils.ApiClient.post(
                        window.APP_CONFIG.API.ENDPOINTS.REGISTER,
                        { name, email, password }
                    );
                    
                    // Success feedback
                    window.alertManager.success(window.APP_CONFIG.MESSAGES.SUCCESS.REGISTER);
                    
                    // Redirect a login
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                    
                } catch (error) {
                    console.error('Errore registrazione:', error);
                    
                    // Mostra errore specifico
                    if (error.message.includes('gi√† registrata')) {
                        showFormErrors(['Questa email √® gi√† registrata. Prova ad accedere.']);
                    } else {
                        showFormErrors([error.message || window.APP_CONFIG.MESSAGES.ERROR.REGISTER_FAILED]);
                    }
                    
                } finally {
                    // Riabilita pulsante
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Crea Account';
                }
            });
        }

        function validateRegisterForm(name, email, password, confirmPassword, termsAccepted) {
            const errors = [];
            
            // Nome
            if (!name) {
                errors.push('Nome √® obbligatorio');
            } else if (name.length < 2) {
                errors.push('Nome deve essere di almeno 2 caratteri');
            } else if (name.length > 50) {
                errors.push('Nome non pu√≤ superare 50 caratteri');
            }
            
            // Email
            if (!email) {
                errors.push('Email √® obbligatoria');
            } else if (!Utils.ValidationUtils.validateEmail(email)) {
                errors.push('Email non √® valida');
            }
            
            // Password
            if (!password) {
                errors.push('Password √® obbligatoria');
            } else if (!Utils.ValidationUtils.validatePassword(password)) {
                errors.push('Password deve essere di almeno 6 caratteri');
            }
            
            // Conferma password
            if (!confirmPassword) {
                errors.push('Conferma password √® obbligatoria');
            } else if (password !== confirmPassword) {
                errors.push('Le password non coincidono');
            }
            
            // Terms
            if (!termsAccepted) {
                errors.push('Devi accettare i termini per continuare');
            }
            
            return errors;
        }

        function showFormErrors(errors) {
            const alertContainer = document.getElementById('formAlerts');
            alertContainer.innerHTML = errors.map(error => `
                <div class="alert alert-error">
                    ${error}
                </div>
            `).join('');
            
            // Scroll to top of form
            alertContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function clearFormErrors() {
            document.getElementById('formAlerts').innerHTML = '';
        }
    </script>
</body>
</html>