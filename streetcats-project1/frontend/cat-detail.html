<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dettaglio Gatto - StreetCats</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <style>
        .cat-image {
            width: 100%;
            max-height: 400px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        #detailMap {
            height: 300px;
            border-radius: 10px;
        }
        
        .cat-info {
            background: #f8f9fa;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 1rem;
        }
        
        .comments-section {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 10px;
            padding: 1.5rem;
        }
        
        .comment-item {
            border-bottom: 1px solid #eee;
            padding: 1rem 0;
        }
        
        .comment-item:last-child {
            border-bottom: none;
        }
        
        .comment-author {
            font-weight: bold;
            color: #495057;
        }
        
        .comment-date {
            font-size: 0.9em;
            color: #6c757d;
        }
        
        .loading {
            text-align: center;
            padding: 2rem;
        }
        
        .description-content {
            line-height: 1.6;
        }
        
        .back-btn {
            margin-bottom: 1rem;
        }
        
        .owner-actions {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="index.html">üê± StreetCats</a>
            <div class="navbar-nav ms-auto">
                <a href="index.html" class="btn btn-outline-light btn-sm">Torna alla Mappa</a>
            </div>
        </div>
    </nav>

    <div class="container py-4">
        <!-- Loading -->
        <div id="loading" class="loading">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Caricamento...</span>
            </div>
            <p>Caricamento dettagli gatto...</p>
        </div>
        
        <!-- Errore -->
        <div id="errorContainer" style="display: none;">
            <div class="alert alert-danger text-center">
                <h4>Gatto non trovato</h4>
                <p>Il gatto che stai cercando non esiste o √® stato rimosso.</p>
                <a href="index.html" class="btn btn-primary">Torna alla Mappa</a>
            </div>
        </div>
        
        <!-- Contenuto principale -->
        <div id="catContent" style="display: none;">
            <div class="back-btn">
                <a href="index.html" class="btn btn-outline-primary">‚Üê Torna alla Mappa</a>
            </div>
            
            <div class="row">
                <!-- Colonna sinistra: Immagine e Info -->
                <div class="col-lg-6 mb-4">
                    <img id="catImage" class="cat-image" alt="Foto del gatto">
                    
                    <div class="cat-info mt-3">
                        <h1 id="catName" class="mb-2"></h1>
                        <p class="text-muted mb-2">
                            <strong>Avvistato il:</strong> <span id="catDate"></span>
                        </p>
                        <p class="text-muted">
                            <strong>Segnalato da:</strong> <span id="catAuthor"></span>
                        </p>
                        
                        <!-- Sezione azioni proprietario -->
                        <div id="ownerActions" class="owner-actions" style="display: none;">
                            <h6>‚öôÔ∏è Azioni Proprietario</h6>
                            <p class="small text-muted mb-2">Sei il proprietario di questo post</p>
                            <button class="btn btn-danger btn-sm" onclick="deleteCat()">
                                üóëÔ∏è Elimina Gatto
                            </button>
                        </div>
                    </div>
                    
                    <!-- Mappa -->
                    <div class="mt-3">
                        <h5>üìç Posizione dell'Avvistamento</h5>
                        <div id="detailMap"></div>
                    </div>
                </div>
                
                <!-- Colonna destra: Descrizione e Commenti -->
                <div class="col-lg-6">
                    <!-- Descrizione -->
                    <div class="mb-4">
                        <h4>Descrizione</h4>
                        <div id="catDescription" class="description-content"></div>
                    </div>
                    
                    <!-- Sezione Commenti -->
                    <div class="comments-section">
                        <h4 class="mb-3">üí¨ Commenti</h4>
                        
                        <!-- Form nuovo commento (solo se loggato) -->
                        <div id="commentForm" style="display: none;">
                            <div class="mb-3">
                                <textarea id="newComment" class="form-control" rows="3" 
                                         placeholder="Scrivi un commento su questo gatto..."></textarea>
                            </div>
                            <button class="btn btn-primary btn-sm" onclick="addComment()">
                                Aggiungi Commento
                            </button>
                            <hr>
                        </div>
                        
                        <!-- Login prompt -->
                        <div id="loginPrompt" style="display: none;">
                            <div class="alert alert-info">
                                <a href="login.html">Effettua il login</a> per aggiungere un commento
                            </div>
                            <hr>
                        </div>
                        
                        <!-- Lista commenti -->
                        <div id="commentsList">
                            <p class="text-muted text-center">Nessun commento ancora. Sii il primo!</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Conferma Eliminazione -->
    <div class="modal fade" id="deleteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Conferma Eliminazione</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Sei sicuro di voler eliminare <strong id="deleteModalCatName"></strong>?</p>
                    <p class="text-danger small">‚ö†Ô∏è Questa azione non pu√≤ essere annullata.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annulla</button>
                    <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                        üóëÔ∏è Elimina Definitivamente
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
        const API_URL = 'http://localhost:3000';
        let map;
        let catId;
        let catData;
        let comments = [];
        let deleteModal;

        // Inizializza la pagina
        document.addEventListener('DOMContentLoaded', function() {
            // Ottieni ID del gatto dall'URL
            const urlParams = new URLSearchParams(window.location.search);
            catId = urlParams.get('id');
            
            if (!catId) {
                showError();
                return;
            }
            
            // Inizializza modal
            deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
            
            checkAuth();
            loadCatDetails();
        });

        function checkAuth() {
            const token = localStorage.getItem('token');
            
            if (token) {
                document.getElementById('commentForm').style.display = 'block';
                document.getElementById('loginPrompt').style.display = 'none';
            } else {
                document.getElementById('commentForm').style.display = 'none';
                document.getElementById('loginPrompt').style.display = 'block';
            }
        }

        async function loadCatDetails() {
            try {
                // Carica dettagli gatto
                const response = await fetch(`${API_URL}/cats/${catId}`);
                
                if (!response.ok) {
                    throw new Error('Gatto non trovato');
                }
                
                catData = await response.json();
                
                // Mostra i dettagli
                displayCatDetails();
                
                // Controlla se l'utente √® il proprietario
                checkOwnership();
                
                // Inizializza mappa
                initMap();
                
                // Carica commenti (simulati per ora)
                loadComments();
                
                // Nasconde loading e mostra contenuto
                document.getElementById('loading').style.display = 'none';
                document.getElementById('catContent').style.display = 'block';
                
            } catch (error) {
                console.error('Errore:', error);
                showError();
            }
        }

        function displayCatDetails() {
            document.getElementById('catName').textContent = catData.name;
            document.getElementById('catDate').textContent = formatDate(catData.date);
            document.getElementById('catAuthor').textContent = catData.author || 'Utente anonimo';
            
            // Immagine
            const img = document.getElementById('catImage');
            img.src = `${API_URL}/uploads/${catData.image}`;
            img.onerror = function() {
                this.src = 'https://via.placeholder.com/400x300?text=Immagine+non+disponibile';
            };
            
            // Descrizione con supporto Markdown base
            const description = document.getElementById('catDescription');
            description.innerHTML = formatDescription(catData.description);
        }

        function checkOwnership() {
            const user = JSON.parse(localStorage.getItem('user') || '{}');
            
            console.log('User ID:', user.id);
            console.log('Cat Author ID:', catData.author);
            
            // Verifica se l'utente corrente √® il proprietario del gatto
            if (user.id && catData.author && user.id === catData.author) {
                document.getElementById('ownerActions').style.display = 'block';
                console.log('Utente proprietario - mostra azioni');
            } else {
                document.getElementById('ownerActions').style.display = 'none';
                console.log('Utente non proprietario - nascondi azioni');
            }
        }

        function deleteCat() {
            // Mostra modal di conferma
            document.getElementById('deleteModalCatName').textContent = catData.name;
            deleteModal.show();
        }

        async function confirmDelete() {
            try {
                const token = localStorage.getItem('token');
                
                if (!token) {
                    alert('Devi essere loggato per eliminare un gatto');
                    return;
                }
                
                console.log('Eliminazione gatto ID:', catId);
                
                const response = await fetch(`${API_URL}/cats/${catId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                console.log('Status eliminazione:', response.status);
                
                if (response.ok) {
                    deleteModal.hide();
                    
                    // Mostra messaggio successo
                    alert('Gatto eliminato con successo!');
                    
                    // Redirect alla homepage
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 1000);
                    
                } else {
                    const error = await response.json();
                    throw new Error(error.message || 'Errore nell\'eliminazione');
                }
                
            } catch (error) {
                console.error('Errore eliminazione:', error);
                alert('Errore nell\'eliminazione: ' + error.message);
            }
        }

        function formatDescription(text) {
            // Supporto base per Markdown
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **grassetto**
                .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *corsivo*
                .replace(/\n/g, '<br>')                           // new lines
                .replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>'); // link
        }

        function initMap() {
            const lat = catData.location.lat;
            const lng = catData.location.lng;
            
            map = L.map('detailMap').setView([lat, lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
            
            // Marker del gatto
            L.marker([lat, lng])
                .addTo(map)
                .bindPopup(`üìç ${catData.name} avvistato qui`)
                .openPopup();
        }

        function loadComments() {
            // Per ora commenti simulati, in futuro si potrebbe estendere l'API
            comments = [
                {
                    id: 1,
                    author: 'Mario Rossi',
                    text: 'Bellissimo gatto! L\'ho visto anch\'io in zona.',
                    date: new Date(Date.now() - 86400000) // ieri
                },
                {
                    id: 2,
                    author: 'Laura Bianchi',
                    text: 'Sembra molto docile, gli ho dato da mangiare.',
                    date: new Date(Date.now() - 172800000) // 2 giorni fa
                }
            ];
            
            displayComments();
        }

        function displayComments() {
            const commentsList = document.getElementById('commentsList');
            
            if (comments.length === 0) {
                commentsList.innerHTML = '<p class="text-muted text-center">Nessun commento ancora. Sii il primo!</p>';
                return;
            }
            
            commentsList.innerHTML = comments.map(comment => `
                <div class="comment-item">
                    <div class="comment-author">${comment.author}</div>
                    <div class="comment-date">${formatDate(comment.date)}</div>
                    <div class="mt-2">${comment.text}</div>
                </div>
            `).join('');
        }

        async function addComment() {
            const textarea = document.getElementById('newComment');
            const text = textarea.value.trim();
            
            if (!text) {
                alert('Scrivi qualcosa nel commento!');
                return;
            }
            
            try {
                // Simula aggiunta commento (in futuro API reale)
                const user = JSON.parse(localStorage.getItem('user'));
                const newComment = {
                    id: comments.length + 1,
                    author: user.name,
                    text: text,
                    date: new Date()
                };
                
                comments.unshift(newComment); // Aggiungi in cima
                displayComments();
                
                // Pulisci textarea
                textarea.value = '';
                
                alert('Commento aggiunto!');
                
            } catch (error) {
                console.error('Errore:', error);
                alert('Errore nell\'aggiungere il commento');
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function showError() {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'block';
        }
    </script>
</body>
</html>